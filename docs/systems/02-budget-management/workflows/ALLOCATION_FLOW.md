# FLOW 02: Budget Management
## à¸à¸²à¸£à¸šà¸£à¸´à¸«à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¹à¸šà¸šà¸„à¸£à¸šà¸§à¸‡à¸ˆà¸£

---

## ðŸ“‹ **à¸ à¸²à¸žà¸£à¸§à¸¡**

Budget Management Flow à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸à¸²à¸£à¸§à¸²à¸‡à¹à¸œà¸™ à¸à¸²à¸£à¸ˆà¸±à¸”à¸ªà¸£à¸£ à¸à¸²à¸£à¸ˆà¸­à¸‡ à¸à¸²à¸£à¸•à¸±à¸”à¸‡à¸š à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡

**5 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸«à¸¥à¸±à¸:**
1. **Budget Planning** - à¸§à¸²à¸‡à¹à¸œà¸™à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¸£à¸²à¸¢à¸›à¸µ
2. **Budget Allocation** - à¸ˆà¸±à¸”à¸ªà¸£à¸£à¸‡à¸šà¹à¸šà¹ˆà¸‡à¸•à¸²à¸¡à¹„à¸•à¸£à¸¡à¸²à¸ª (Q1-Q4)
3. **Budget Check** - à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‡à¸šà¸„à¸‡à¹€à¸«à¸¥à¸·à¸­
4. **Budget Reservation** - à¸ˆà¸­à¸‡à¸‡à¸šà¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§ (à¸ªà¸³à¸«à¸£à¸±à¸š PR)
5. **Budget Commitment** - à¸•à¸±à¸”à¸‡à¸šà¸ˆà¸£à¸´à¸‡ (à¹€à¸¡à¸·à¹ˆà¸­ approve PO)

---

## ðŸ”„ **Complete Flow Diagram**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BUDGET MANAGEMENT LIFECYCLE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 1: ANNUAL PLANNING (à¸•à¹‰à¸™à¸›à¸µà¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Finance Manager                     â”‚
â”‚ â””â”€> Plan Annual Budget             â”‚
â”‚     â”œâ”€> Total: 18M à¸šà¸²à¸—            â”‚
â”‚     â”œâ”€> Q1: 4.5M (Jan-Mar)        â”‚
â”‚     â”œâ”€> Q2: 4.5M (Apr-Jun)        â”‚
â”‚     â”œâ”€> Q3: 4.5M (Jul-Sep)        â”‚
â”‚     â””â”€> Q4: 4.5M (Oct-Dec)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
Phase 2: ALLOCATION (à¹à¸šà¹ˆà¸‡à¸•à¸²à¸¡à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Allocate to Departments             â”‚
â”‚ â”œâ”€> Pharmacy Dept: 10M             â”‚
â”‚ â”‚   â””â”€> Budget Type: OP001 (à¸¢à¸²)   â”‚
â”‚ â”œâ”€> Nursing Dept: 5M               â”‚
â”‚ â”‚   â””â”€> Budget Type: OP001 (à¸¢à¸²)   â”‚
â”‚ â””â”€> Medical Dept: 3M               â”‚
â”‚     â””â”€> Budget Type: OP002 (à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
Phase 3: USAGE (à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Department creates Purchase Request â”‚
â”‚ â””â”€> Check Budget Available?        â”‚
â”‚     â”œâ”€[YES]â”€> Reserve Budget       â”‚
â”‚     â”‚         (Lock temporarily)    â”‚
â”‚     â”‚         â””â”€> Create PR         â”‚
â”‚     â”‚             â””â”€> Approve PR    â”‚
â”‚     â”‚                 â””â”€> Create PO â”‚
â”‚     â”‚                     â””â”€> Commitâ”‚
â”‚     â”‚                         Budgetâ”‚
â”‚     â””â”€[NO]â”€â”€> Request More Budget  â”‚
â”‚                or Adjust PR         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
Phase 4: MONITORING (à¸•à¸´à¸”à¸•à¸²à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Real-time Budget Tracking           â”‚
â”‚ â”œâ”€> Total Spent                     â”‚
â”‚ â”œâ”€> Remaining Budget                â”‚
â”‚ â”œâ”€> Utilization % (per Quarter)    â”‚
â”‚ â”œâ”€> Reserved Amount                 â”‚
â”‚ â””â”€> Alert if > 80%                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ–¥ï¸ **UI MOCKUP: Budget Allocation Screen**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  INVS Modern - Budget Allocation (FY 2025)               [X]  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  ðŸ’° Create New Budget Allocation                               â•‘
â•‘                                                                â•‘
â•‘  Fiscal Year:  [2025    ] (Jan 1 - Dec 31, 2025)             â•‘
â•‘  Department:   [â–¼ Pharmacy Department (PHARM)           ]     â•‘
â•‘  Budget Type:  [â–¼ OP001 - à¸‡à¸šà¸”à¸³à¹€à¸™à¸´à¸™à¸‡à¸²à¸™ (à¸¢à¸²)              ]     â•‘
â•‘                                                                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚  QUARTERLY BREAKDOWN                                     â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚  Total Budget:    [10,000,000.00] à¸šà¸²à¸—                   â”‚ â•‘
â•‘  â”‚                                                          â”‚ â•‘
â•‘  â”‚  Q1 (Jan-Mar):    [2,500,000.00] à¸šà¸²à¸— (25%)             â”‚ â•‘
â•‘  â”‚  Q2 (Apr-Jun):    [2,500,000.00] à¸šà¸²à¸— (25%)             â”‚ â•‘
â•‘  â”‚  Q3 (Jul-Sep):    [2,500,000.00] à¸šà¸²à¸— (25%)             â”‚ â•‘
â•‘  â”‚  Q4 (Oct-Dec):    [2,500,000.00] à¸šà¸²à¸— (25%)             â”‚ â•‘
â•‘  â”‚                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚ â•‘
â•‘  â”‚  Total:           10,000,000.00 à¸šà¸²à¸— âœ“                   â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                                â•‘
â•‘  Status: [â–¼ ACTIVE  ]                                         â•‘
â•‘          [ ] INACTIVE                                          â•‘
â•‘          [âœ“] ACTIVE                                            â•‘
â•‘          [ ] LOCKED                                            â•‘
â•‘                                                                â•‘
â•‘  [ Cancel ]                    [ Create Allocation ]           â•‘
â•‘                                                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ðŸ“Š Budget Summary - FY 2025                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚Dept  â”‚ Budget â”‚ Total  â”‚ Spent      â”‚ Remaining  â”‚ %  â”‚   â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤   â•‘
â•‘  â”‚PHARM â”‚ OP001  â”‚ 10.0M  â”‚ 0.00       â”‚ 10.0M      â”‚ 0% â”‚   â•‘
â•‘  â”‚NURSE â”‚ OP001  â”‚ 5.0M   â”‚ 0.00       â”‚ 5.0M       â”‚ 0% â”‚   â•‘
â•‘  â”‚MED   â”‚ OP002  â”‚ 3.0M   â”‚ 0.00       â”‚ 3.0M       â”‚ 0% â”‚   â•‘
â•‘  â”‚      â”‚        â”‚        â”‚            â”‚            â”‚    â”‚   â•‘
â•‘  â”‚TOTAL â”‚        â”‚ 18.0M  â”‚ 0.00       â”‚ 18.0M      â”‚ 0% â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ“Š **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: STEP 1 - Create Budget Allocation**

### Input Data

```json
{
  "fiscalYear": 2025,
  "departmentId": 2,
  "budgetTypeId": 1,
  "totalBudget": 10000000.00,
  "q1Budget": 2500000.00,
  "q2Budget": 2500000.00,
  "q3Budget": 2500000.00,
  "q4Budget": 2500000.00,
  "status": "ACTIVE"
}
```

### Database Operation

```sql
-- INSERT Budget Allocation
INSERT INTO budget_allocations (
  fiscal_year,
  budget_type_id,
  department_id,
  total_budget,
  q1_budget,
  q2_budget,
  q3_budget,
  q4_budget,
  total_spent,
  q1_spent,
  q2_spent,
  q3_spent,
  q4_spent,
  remaining_budget,
  status,
  created_at
) VALUES (
  2025,
  1, -- OP001
  2, -- Pharmacy Dept
  10000000.00,
  2500000.00,
  2500000.00,
  2500000.00,
  2500000.00,
  0.00,
  0.00,
  0.00,
  0.00,
  0.00,
  10000000.00,
  'active',
  CURRENT_TIMESTAMP
);

-- Verify with View
SELECT * FROM budget_status_current
WHERE fiscal_year = 2025
  AND dept_code = 'PHARM';
```

### Expected Result

```
allocation_id | fiscal_year | budget_code | dept_code | total_budget | total_spent | remaining | utilization_%
--------------+-------------+-------------+-----------+--------------+-------------+-----------+--------------
      1       |    2025     |   OP001     |   PHARM   | 10,000,000   |    0.00     | 10,000,000|    0.00%
```

---

## ðŸ“Š **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: STEP 2 - Check Budget Availability**

### Scenario: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‡à¸šà¸à¹ˆà¸­à¸™à¸ªà¸£à¹‰à¸²à¸‡ PR

```sql
-- Call Function: check_budget_availability
SELECT * FROM check_budget_availability(
  p_fiscal_year := 2025,
  p_budget_type_id := 1,
  p_department_id := 2,
  p_amount := 500000.00,
  p_quarter := 1
);
```

### Output

```
available | allocation_id | total_budget | total_spent | remaining_budget | quarter_budget | quarter_spent | quarter_remaining | message
----------+---------------+--------------+-------------+------------------+----------------+---------------+-------------------+---------------------------
   true   |       1       | 10,000,000   |    0.00     |   10,000,000     |   2,500,000    |     0.00      |    2,500,000      | Budget available for Q1
```

---

## ðŸ–¥ï¸ **UI MOCKUP: Budget Check Dialog**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Budget Availability Check                             [X] â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                            â•‘
â•‘  Department:    Pharmacy Department                        â•‘
â•‘  Budget Type:   OP001 - à¸‡à¸šà¸”à¸³à¹€à¸™à¸´à¸™à¸‡à¸²à¸™ (à¸¢à¸²)                  â•‘
â•‘  Request Amount: 500,000.00 à¸šà¸²à¸—                           â•‘
â•‘  Quarter:       Q1 (January - March 2025)                  â•‘
â•‘                                                            â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  BUDGET SUMMARY                                    â”‚   â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘  â”‚  Q1 Total Budget:         2,500,000.00 à¸šà¸²à¸—        â”‚   â•‘
â•‘  â”‚  Q1 Already Spent:                0.00 à¸šà¸²à¸—        â”‚   â•‘
â•‘  â”‚  Q1 Reserved:                     0.00 à¸šà¸²à¸—        â”‚   â•‘
â•‘  â”‚  Q1 Available:            2,500,000.00 à¸šà¸²à¸—  âœ“     â”‚   â•‘
â•‘  â”‚                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚   â•‘
â•‘  â”‚  Request Amount:            500,000.00 à¸šà¸²à¸—        â”‚   â•‘
â•‘  â”‚  After Reserve:           2,000,000.00 à¸šà¸²à¸—        â”‚   â•‘
â•‘  â”‚                                                    â”‚   â•‘
â•‘  â”‚  Status:  âœ… BUDGET AVAILABLE                      â”‚   â•‘
â•‘  â”‚  Utilization: 20% (After reserve)                  â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                            â•‘
â•‘             [ Cancel ]        [ Proceed with PR ]          â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ“Š **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: STEP 3 - Reserve Budget**

### Scenario: à¸ˆà¸­à¸‡à¸‡à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡ Purchase Request

```sql
-- Call Function: reserve_budget
SELECT reserve_budget(
  p_allocation_id := 1,
  p_pr_id := 1,
  p_amount := 500000.00,
  p_expires_days := 30
) as reservation_id;
```

### Output

```
reservation_id
--------------
      1
```

### Verify Reservation

```sql
SELECT
  br.id,
  br.reserved_amount,
  br.reservation_date,
  br.expires_date,
  br.status,
  pr.pr_number
FROM budget_reservations br
JOIN purchase_requests pr ON br.pr_id = pr.id
WHERE br.id = 1;
```

### Result

```
id | reserved_amount | reservation_date | expires_date | status | pr_number
---+-----------------+------------------+--------------+--------+-----------
 1 |    500,000.00   |   2025-01-15     |  2025-02-14  | active | PR-2025-001
```

---

## ðŸ–¥ï¸ **UI MOCKUP: Budget Reservation Dashboard**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  INVS Modern - Budget Reservations                        [X] â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  ðŸ“Š Active Budget Reservations (2025)                          â•‘
â•‘                                                                â•‘
â•‘  Filters: [All Depts â–¼] [All Budgets â–¼] [Q1 â–¼] [ðŸ” Search]   â•‘
â•‘                                                                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚PR#       â”‚Dept â”‚Budgetâ”‚Amount     â”‚Reserved â”‚Expires  â”‚â—„â”€â”¼â”€â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤ â•‘
â•‘  â”‚PR-2025-001â”‚PHARMâ”‚OP001 â”‚  500,000  â”‚01/15/25â”‚02/14/25 â”‚â°â”‚ â•‘
â•‘  â”‚PR-2025-002â”‚NURSEâ”‚OP001 â”‚  300,000  â”‚01/16/25â”‚02/15/25 â”‚â°â”‚ â•‘
â•‘  â”‚PR-2025-003â”‚MED  â”‚OP002 â”‚  800,000  â”‚01/10/25â”‚02/09/25 â”‚âš â”‚ â•‘
â•‘  â”‚PR-2025-004â”‚PHARMâ”‚OP001 â”‚  200,000  â”‚01/18/25â”‚02/17/25 â”‚â°â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”˜ â•‘
â•‘                                                                â•‘
â•‘  Legend: â° = Active  âš  = Expiring Soon  âŒ = Expired         â•‘
â•‘                                                                â•‘
â•‘  Total Reserved: 1,800,000.00 à¸šà¸²à¸—                             â•‘
â•‘                                                                â•‘
â•‘  Actions: [Release Selected] [Convert to PO] [Export Report]  â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ“Š **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: STEP 4 - Commit Budget**

### Scenario: à¸•à¸±à¸”à¸‡à¸šà¸ˆà¸£à¸´à¸‡à¹€à¸¡à¸·à¹ˆà¸­ approve Purchase Order

```sql
-- Call Function: commit_budget
SELECT commit_budget(
  p_allocation_id := 1,
  p_po_id := 1,
  p_amount := 500000.00,
  p_quarter := 1
);
```

### Output

```
commit_budget
-------------
    true
```

### Verify Budget Update

```sql
-- Check Budget Allocation
SELECT
  fiscal_year,
  total_budget,
  total_spent,
  remaining_budget,
  q1_budget,
  q1_spent,
  (q1_spent / q1_budget * 100) as q1_utilization_pct
FROM budget_allocations
WHERE id = 1;
```

### Result

```
fiscal_year | total_budget | total_spent | remaining_budget | q1_budget | q1_spent | q1_utilization_pct
------------+--------------+-------------+------------------+-----------+----------+-------------------
   2025     | 10,000,000   |  500,000    |   9,500,000      | 2,500,000 | 500,000  |      20.00%
```

### Check Reservation Status

```sql
SELECT
  id,
  reserved_amount,
  status,
  po_id
FROM budget_reservations
WHERE pr_id = 1;
```

### Result

```
id | reserved_amount | status    | po_id
---+-----------------+-----------+------
 1 |    500,000.00   | committed |   1
```

---

## ðŸ–¥ï¸ **UI MOCKUP: Budget Dashboard (After Commit)**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  INVS Modern - Budget Dashboard (FY 2025)                 [X] â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  ðŸ’° Budget Utilization - Q1 2025                               â•‘
â•‘                                                                â•‘
â•‘  Department: Pharmacy (PHARM) | Budget: OP001 - à¸¢à¸²             â•‘
â•‘                                                                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚  QUARTER 1 (January - March 2025)                        â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚  Allocated:       2,500,000.00 à¸šà¸²à¸—                       â”‚ â•‘
â•‘  â”‚  Spent:             500,000.00 à¸šà¸²à¸—  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  20%     â”‚ â•‘
â•‘  â”‚  Reserved:          300,000.00 à¸šà¸²à¸—  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  12%     â”‚ â•‘
â•‘  â”‚  Available:       1,700,000.00 à¸šà¸²à¸—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  68%     â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚  ANNUAL SUMMARY                                          â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚  Total Budget:   10,000,000.00 à¸šà¸²à¸—                       â”‚ â•‘
â•‘  â”‚  Total Spent:       500,000.00 à¸šà¸²à¸—  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   5%     â”‚ â•‘
â•‘  â”‚  Total Reserved:    300,000.00 à¸šà¸²à¸—  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   3%     â”‚ â•‘
â•‘  â”‚  Remaining:       9,200,000.00 à¸šà¸²à¸—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  92%     â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                                â•‘
â•‘  âš ï¸ Alerts:                                                    â•‘
â•‘  â€¢ PR-2025-003 reservation expires in 5 days                   â•‘
â•‘  â€¢ Q1 budget 20% utilized (on track)                           â•‘
â•‘                                                                â•‘
â•‘  [View Details] [Generate Report] [Budget Transfer]            â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ“Š **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: STEP 5 - Release Budget**

### Scenario: à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸‡à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸¢à¸à¹€à¸¥à¸´à¸ PR

```sql
-- Call Function: release_budget
SELECT release_budget(p_reservation_id := 2);
```

### Output

```
release_budget
--------------
     true
```

### Verify

```sql
SELECT
  id,
  reserved_amount,
  status,
  pr_id
FROM budget_reservations
WHERE id = 2;
```

### Result

```
id | reserved_amount | status   | pr_id
---+-----------------+----------+------
 2 |    300,000.00   | released |   2
```

---

## âœ… **Validation Rules**

### 1. Budget Allocation Validation

```sql
-- Check if allocation already exists for the year
SELECT COUNT(*) FROM budget_allocations
WHERE fiscal_year = 2025
  AND budget_type_id = 1
  AND department_id = 2;
-- Must be 0 for new allocation

-- Validate quarterly sum equals total
SELECT
  (q1_budget + q2_budget + q3_budget + q4_budget) = total_budget as valid
FROM budget_allocations WHERE id = :allocation_id;
-- Must return true
```

### 2. Budget Availability Check

```sql
-- Check remaining budget
SELECT remaining_budget >= :requested_amount as sufficient
FROM budget_allocations
WHERE id = :allocation_id AND status = 'active';
-- Must return true

-- Check quarterly budget
SELECT
  CASE
    WHEN :quarter = 1 THEN (q1_budget - q1_spent) >= :amount
    WHEN :quarter = 2 THEN (q2_budget - q2_spent) >= :amount
    WHEN :quarter = 3 THEN (q3_budget - q3_spent) >= :amount
    WHEN :quarter = 4 THEN (q4_budget - q4_spent) >= :amount
  END as sufficient
FROM budget_allocations WHERE id = :allocation_id;
-- Must return true
```

### 3. Reservation Validation

```sql
-- Check if budget available
SELECT remaining_budget >= :amount FROM budget_allocations WHERE id = :id;

-- Check if reservation expired
SELECT CURRENT_DATE <= expires_date FROM budget_reservations WHERE id = :id;

-- Check if already committed
SELECT status = 'active' FROM budget_reservations WHERE id = :id;
```

---

## ðŸš¨ **Error Handling**

### Common Errors

| Error Code | Message | Solution |
|------------|---------|----------|
| `BUD001` | Budget allocation already exists | Use different dept/type/year |
| `BUD002` | Insufficient budget | Reduce amount or request more budget |
| `BUD003` | Quarterly sum doesn't match total | Adjust quarterly amounts |
| `BUD004` | Reservation expired | Create new PR or extend expiry |
| `BUD005` | Budget allocation not active | Activate budget first |
| `BUD006` | Quarter budget exceeded | Wait for next quarter or adjust |

### Example Error Response

```json
{
  "success": false,
  "errorCode": "BUD002",
  "message": "Insufficient budget in Q1",
  "details": {
    "requested": 500000.00,
    "available": 300000.00,
    "quarter": 1
  },
  "suggestion": "Reduce PR amount to 300,000 à¸šà¸²à¸— or below"
}
```

---

## ðŸ“ˆ **Budget Monitoring Queries**

### Query 1: Budget Utilization by Department

```sql
SELECT
  dept.dept_name,
  bt.budget_name,
  ba.fiscal_year,
  ba.total_budget,
  ba.total_spent,
  ba.remaining_budget,
  ROUND((ba.total_spent / ba.total_budget * 100), 2) as utilization_pct,
  CASE
    WHEN ba.total_spent > ba.total_budget THEN 'OVER_BUDGET'
    WHEN (ba.total_spent / ba.total_budget) > 0.8 THEN 'HIGH'
    WHEN (ba.total_spent / ba.total_budget) > 0.5 THEN 'MEDIUM'
    ELSE 'LOW'
  END as alert_level
FROM budget_allocations ba
JOIN departments dept ON ba.department_id = dept.id
JOIN budget_types bt ON ba.budget_type_id = bt.id
WHERE ba.fiscal_year = 2025
  AND ba.status = 'active'
ORDER BY utilization_pct DESC;
```

### Query 2: Quarterly Budget Tracking

```sql
SELECT
  dept_name,
  budget_name,
  'Q1' as quarter,
  q1_budget as allocated,
  q1_spent as spent,
  (q1_budget - q1_spent) as remaining,
  ROUND((q1_spent / q1_budget * 100), 2) as utilization_pct
FROM budget_status_current
WHERE fiscal_year = 2025
UNION ALL
SELECT
  dept_name, budget_name, 'Q2', q2_budget, q2_spent,
  (q2_budget - q2_spent), ROUND((q2_spent / q2_budget * 100), 2)
FROM budget_status_current WHERE fiscal_year = 2025
-- ... Q3, Q4
ORDER BY dept_name, quarter;
```

### Query 3: Budget Reservations Summary

```sql
SELECT
  dept.dept_name,
  COUNT(*) as total_reservations,
  SUM(br.reserved_amount) as total_reserved,
  COUNT(CASE WHEN br.status = 'active' THEN 1 END) as active_count,
  COUNT(CASE WHEN br.expires_date < CURRENT_DATE THEN 1 END) as expired_count
FROM budget_reservations br
JOIN budget_allocations ba ON br.allocation_id = ba.id
JOIN departments dept ON ba.department_id = dept.id
WHERE ba.fiscal_year = 2025
GROUP BY dept.dept_name
ORDER BY total_reserved DESC;
```

---

## ðŸŽ¯ **Success Criteria**

### âœ… Budget Management Checklist

- [ ] Budget allocations created for all departments
- [ ] Quarterly breakdown sums equal total budget
- [ ] Budget check function works correctly
- [ ] Budget reservation creates lock on amount
- [ ] Budget commitment deducts from allocation
- [ ] Budget release unlocks reserved amount
- [ ] Dashboard shows real-time utilization
- [ ] Alerts trigger at 80% utilization
- [ ] Expired reservations flagged
- [ ] Budget transfer workflow functional

### Key Performance Indicators

```
Metric                    | Target  | Current
--------------------------+---------+---------
Budget Accuracy           | 100%    | 100%
Reservation Expiry Rate   | < 5%    | 0%
Over-budget Incidents     | 0       | 0
Budget Utilization (Q1)   | 20-30%  | 20%
System Response Time      | < 2 sec | 0.5 sec
```

---

## ðŸŽ¯ **Next Steps**

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸ Budget Management à¸žà¸£à¹‰à¸­à¸¡:

1. âœ… **Create Purchase Requests** - à¸ªà¸£à¹‰à¸²à¸‡ PR à¸žà¸£à¹‰à¸­à¸¡à¸ˆà¸­à¸‡à¸‡à¸š (FLOW 03)
2. âœ… **Monitor Budget Usage** - à¸•à¸´à¸”à¸•à¸²à¸¡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸š real-time
3. âœ… **Handle Budget Transfers** - à¸ˆà¸±à¸”à¸à¸²à¸£à¹‚à¸­à¸™à¸‡à¸šà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™
4. âœ… **Generate Budget Reports** - à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“

---

**ðŸ“ Note**: Budget Management à¹€à¸›à¹‡à¸™à¸«à¸±à¸§à¹ƒà¸ˆà¸ªà¸³à¸„à¸±à¸à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š INVS à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡à¹à¸¥à¸°à¸•à¸´à¸”à¸•à¸²à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸„à¸£à¹ˆà¸‡à¸„à¸£à¸±à¸”à¹€à¸žà¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¹€à¸à¸´à¸™à¸‡à¸š
