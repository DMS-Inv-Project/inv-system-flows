# 📖 วิเคราะห์ระบบจัดซื้อจากคู่มือ INVS เดิม

**แหล่งข้อมูล:** INVS_MANUAL-01.pdf (ระบบเดิม)
**วันที่วิเคราะห์:** 20 ตุลาคม 2568
**สถานะ:** 🔄 กำลังวิเคราะห์ (รอข้อมูล MySQL)

---

## 📋 ภาพรวมจากคู่มือ

จากการศึกษาคู่มือ INVS เดิม พบว่าระบบมีโมดูลหลัก 6 โมดูล:

1. **ระบบวางแผนจัดซื้อ** (Budget Planning)
2. **ระบบสัญญา** (Contract Management) ⭐
3. **ระบบจัดซื้อ** (Procurement)
4. **ระบบรับเข้าคลัง** (Receiving)
5. **ระบบคลัง** (Inventory)
6. **ระบบรายงาน** (Reporting)

---

## 🔍 ผลการวิเคราะห์แต่ละโมดูล

### 1. ระบบวางแผนจัดซื้อ (Budget Planning)

**หน้าจอหลัก:**
- หน้าจอวางแผนงบประมาณรายปี
- แผนการจัดซื้อตามไตรมาส (Q1-Q4)
- การจัดสรรงบประมาณตามหมวด

**ฟีเจอร์สำคัญ:**
```
✅ กำหนดงบประมาณรายปี
✅ แบ่งงบตามไตรมาส (Q1, Q2, Q3, Q4)
✅ จัดสรรงบตามหมวดค่าใช้จ่าย (ยา, เวชภัณฑ์, เครื่องมือ)
✅ ติดตามงบคงเหลือ
✅ แจ้งเตือนงบใกล้หมด
```

**ตารางที่เกี่ยวข้อง (คาดการณ์):**
```sql
- buyplan (แผนการจัดซื้อ)
- buyplan_c (รายการยาในแผน)
- budget_allocation (จัดสรรงบประมาณ)
```

**สิ่งที่ระบบเรามีแล้ว:**
- ✅ `budget_allocations` - จัดสรรงบตามไตรมาส
- ✅ `budget_plans` - แผนจัดซื้อรายยา
- ✅ `budget_plan_items` - รายการยาพร้อมข้อมูล 3 ปี

**สิ่งที่ยังขาด:**
- 🟡 UI สำหรับวางแผนจัดซื้อ
- 🟡 การคำนวณปริมาณแนะนำอัตโนมัติ

---

### 2. ระบบสัญญา (Contract Management) ⭐ **สำคัญมาก**

**หน้าจอหลัก:**
- บันทึกสัญญาจัดซื้อ
- กำหนดรายการยาและราคาในสัญญา
- ติดตามวงเงินสัญญา
- แจ้งเตือนสัญญาใกล้หมดอายุ

**ประเภทสัญญา:**
```
1. สัญญาตกลงราคา (Price Agreement)
2. สัญญา e-bidding
3. สัญญาสอบราคา (Quotation)
4. สัญญาเฉพาะกิจ
```

**ฟีเจอร์สำคัญ:**
```
✅ บันทึกข้อมูลสัญญา
   - เลขที่สัญญา
   - วันที่เริ่ม - สิ้นสุด
   - ผู้ขาย
   - วงเงิน
   - เงื่อนไขการชำระเงิน

✅ กำหนดรายการยาในสัญญา
   - ยา + ราคาต่อหน่วย
   - ปริมาณขั้นต่ำ - สูงสุด
   - ส่วนลด (ถ้ามี)

✅ ตรวจสอบสัญญาเมื่อสั่งซื้อ
   - ดึงราคาจากสัญญาอัตโนมัติ
   - เช็คว่าซื้อเกินสัญญาหรือไม่
   - แจ้งเตือนถ้าราคาต่างจากสัญญา

✅ ติดตามการใช้สัญญา
   - สั่งซื้อไปแล้วเท่าไร
   - คงเหลือเท่าไร
   - ใกล้หมดอายุหรือไม่
```

**ตารางที่เกี่ยวข้อง (จากคู่มือ):**
```sql
❌ ระบบเราไม่มี:
- contract (ข้อมูลสัญญา)
  - contract_id
  - contract_no (เลขที่สัญญา)
  - contract_type (ประเภท)
  - vendor_id
  - start_date, end_date
  - total_amount
  - payment_term
  - status

- contract_item (รายการในสัญญา)
  - contract_id
  - drug_id
  - unit_price (ราคาตามสัญญา)
  - min_qty, max_qty
  - discount
```

**ผลกระทบต่อระบบเรา:**
```
❌ Critical: ไม่มีตารางสัญญา = ไม่สามารถบันทึกสัญญาได้
❌ Critical: ไม่มี contract_item = ไม่มีราคาอ้างอิง
❌ High: ไม่สามารถดึงราคาจากสัญญามาใส่ PO อัตโนมัติ
❌ High: ไม่สามารถเช็คว่าซื้อเกินสัญญา
❌ Medium: ไม่มีการแจ้งเตือนสัญญาใกล้หมดอายุ
```

---

### 3. ระบบจัดซื้อ (Procurement)

**Flow การทำงาน (จากคู่มือ):**

#### 3.1 หน้าจอ "ควรซื้ออะไร?" (Reorder Suggestion)

**วัตถุประสงค์:** ช่วยเจ้าหน้าที่ตัดสินใจว่าควรสั่งซื้ออะไร

**ข้อมูลที่แสดง:**
```
✅ รายการยาที่คงคลัง < จุดสั่งซื้อ (Reorder Point)
✅ จำนวนที่แนะนำให้สั่งซื้อ (Suggested Quantity)
   คำนวณจาก: Max - (On Hand + On Order)

✅ อัตราการใช้เฉลี่ย (Average Usage)
   - ใช้เฉลี่ย/วัน, /เดือน
   - แนวโน้มการใช้

✅ ข้อมูลการซื้อล่าสุด
   - ผู้ขายคนล่าสุด
   - ราคาล่าสุด
   - วันที่ซื้อล่าสุด

✅ ข้อมูลสัญญา (ถ้ามี) ⭐
   - เลขที่สัญญา
   - ราคาตามสัญญา
   - วันหมดอายุสัญญา

✅ ABC-VEN Analysis (ถ้ามี)
   - A/B/C = มูลค่า
   - V/E/N = ความจำเป็น
```

**ตัวอย่างหน้าจอ:**
```
┌─────────────────────────────────────────────────────────────────┐
│ รายการยาที่ควรสั่งซื้อ                                         │
├──────┬───────────┬────────┬──────┬─────────┬─────────┬─────────┤
│ ยา   │ คงคลัง   │ จุดสั่ง│ แนะนำ│ ผู้ขาย  │ ราคา    │ สัญญา   │
├──────┼───────────┼────────┼──────┼─────────┼─────────┼─────────┤
│ Para │ 500       │ 1000   │ 9500 │ GPO     │ 1.50    │ C001    │
│ Amox │ 300       │ 800    │ 4700 │ Zuellig │ 3.00    │ C002    │
│ ...  │           │        │      │         │         │         │
└──────┴───────────┴────────┴──────┴─────────┴─────────┴─────────┘
```

**สิ่งที่ระบบเราต้องมี:**
```sql
❌ ไม่มี VIEW: reorder_suggestions
❌ ไม่มี function: calculate_suggested_quantity()
❌ ไม่มี function: get_average_usage()
❌ ไม่มี function: get_last_purchase_info()
❌ ไม่มีข้อมูลสัญญาเพื่อแสดง
```

---

#### 3.2 สร้างใบสั่งซื้อ (PO)

**ขั้นตอนจากคู่มือ:**

**Step 1: เลือกผู้ขาย**
```
✅ เลือกจาก dropdown
✅ แสดงข้อมูลผู้ขาย (ชื่อ, ที่อยู่, โทร)
✅ แสดงสัญญาที่ใช้ได้ (ถ้ามี)
```

**Step 2: เลือกยา**
```
✅ ค้นหายา (รหัส/ชื่อ)
✅ ดึงราคาจากสัญญา (ถ้ามี) ⭐
✅ กรอกจำนวน
✅ คำนวณมูลค่ารวมอัตโนมัติ

⚠️ แจ้งเตือน:
   - ถ้าราคาต่างจากสัญญา
   - ถ้าซื้อเกินสัญญา
   - ถ้างบประมาณไม่พอ
```

**Step 3: เช็คงบประมาณ**
```
✅ ตรวจสอบงบคงเหลือ (Budget Available)
✅ จองงบอัตโนมัติ (Budget Reservation)
✅ แจ้งเตือนถ้างบไม่พอ
✅ แสดงงบคงเหลือหลังจอง
```

**Step 4: สร้างใบขออนุมัติพร้อมกับ PO**
```
✅ ระบบสร้าง 2 เอกสารพร้อมกัน:
   1. ใบสั่งซื้อ (PO) - เลขที่ PO-XXXX
   2. ใบขออนุมัติ - เลขที่ APV-XXXX

✅ ข้อมูลในใบขออนุมัติ:
   - เลขที่ใบขออนุมัติ
   - อ้างอิงเลขที่ PO
   - หมวดงบประมาณ
   - รายการสรุป
   - มูลค่ารวม
   - เหตุผลความจำเป็น
   - ผู้ขออนุมัติ
```

**สิ่งที่ระบบเราต้องมี:**
```
✅ มีแล้ว: purchase_orders
🟡 ต้องเพิ่ม: approval_documents (เลขที่แยก)
❌ ต้องเพิ่ม: contract_id ใน purchase_orders
❌ ต้องเพิ่ม: function auto-fill ราคาจากสัญญา
❌ ต้องเพิ่ม: validation เช็คสัญญา
```

---

#### 3.3 ขออนุมัติ

**Flow การอนุมัติ (จากคู่มือ):**

```
1. เจ้าหน้าที่คลัง → ส่งขออนุมัติ
   ↓
2. หัวหน้าเภสัช → อนุมัติเบื้องต้น (ถ้ามูลค่า < 100,000)
   ↓
3. ผู้อำนวยการ → อนุมัติขั้นสุดท้าย
   ↓
4. ระบบเปลี่ยนสถานะ PO → APPROVED
   ↓
5. พิมพ์ใบสั่งซื้อส่งผู้ขาย
```

**Approval Rules (ตัวอย่าง):**
```
- มูลค่า < 100,000 บาท → หัวหน้าเภสัชอนุมัติได้เลย
- มูลค่า 100,000 - 500,000 → ผู้อำนวยการ
- มูลค่า > 500,000 → คณะกรรมการพิจารณา
```

**สิ่งที่ระบบเราต้องมี:**
```
✅ มีแล้ว: approvedBy, approvalDate
🟡 ต้องเพิ่ม: approval workflow (multi-level)
🟡 ต้องเพิ่ม: approval history log
```

---

### 4. ระบบรับเข้าคลัง (Receiving)

**Flow รับเข้าคลัง (จากคู่มือ):**

#### 4.1 บันทึกรับเวชภัณฑ์

**หน้าจอ: บันทึกรับเข้า**

```
┌──────────────────────────────────────────────┐
│ บันทึกรับเวชภัณฑ์เข้าคลัง                   │
├──────────────────────────────────────────────┤
│                                              │
│ เลขที่ PO: [______] 🔍 ค้นหา              │
│                                              │
│ ผู้ขาย: GPO                                 │
│ วันที่ส่งของ: [__/__/____]                 │
│                                              │
│ เลขที่ Invoice: [___________] ⭐ บังคับ    │
│ วันที่ Invoice: [__/__/____]  ⭐ บังคับ    │
│ เลขที่ Delivery Note: [_____]               │
│                                              │
│ ┌────────────────────────────────────────┐  │
│ │ รายการรับ                              │  │
│ ├────┬─────┬─────┬────┬──────┬─────────┤  │
│ │ ยา │ สั่ง│ รับ │Lot │ Exp  │ ที่เก็บ │  │
│ ├────┼─────┼─────┼────┼──────┼─────────┤  │
│ │Para│10000│10000│L001│12/26 │ MAIN    │  │
│ │Amox│ 5000│ 5000│L002│06/26 │ MAIN    │  │
│ └────┴─────┴─────┴────┴──────┴─────────┘  │
│                                              │
│ ⚠️ ต้องกรอก Lot และ Exp ให้ครบทุกรายการ  │
│                                              │
│ [บันทึก] [พิมพ์ใบนำส่ง] [ยกเลิก]          │
└──────────────────────────────────────────────┘
```

**ฟิลด์ที่บังคับกรอก:**
```
✅ เลขที่ PO (เลือกจาก dropdown)
✅ เลขที่ Invoice ⭐ สำคัญ
✅ วันที่ Invoice ⭐ สำคัญ
✅ จำนวนรับจริง (แต่ละรายการ)
✅ Lot Number (แต่ละรายการ) ⭐ บังคับ
✅ วันหมดอายุ (แต่ละรายการ) ⭐ บังคับ
✅ สถานที่เก็บ
```

**การตรวจสอบ:**
```
✅ ตรวจสอบ Lot ซ้ำ (แจ้งเตือน)
✅ ตรวจสอบวันหมดอายุ (ถ้า < 6 เดือน แจ้งเตือน)
✅ ตรวจสอบจำนวนรับ vs สั่ง (ถ้าต่างกัน แจ้งเตือน)
```

**สิ่งที่ระบบเราต้องมี:**
```
✅ มีแล้ว: receipts, receipt_items
🟡 ต้องเพิ่ม: invoice_number, invoice_date ⭐ สำคัญ
✅ มีแล้ว: lotNumber, expiryDate ใน receipt_items
```

---

#### 4.2 พิมพ์เอกสาร

**เอกสารที่พิมพ์ได้:**

**1. ใบนำส่งเวชภัณฑ์เข้าคลัง**
```
- เลขที่ใบนำส่ง
- วันที่รับ
- เลขที่ PO
- ผู้ขาย
- รายการยาที่รับ (พร้อม Lot, Exp)
- จำนวนรับ
- ผู้รับของ (ลายเซ็น)
```

**2. ใบตรวจรับ (สำหรับกรรมการ)**
```
- เลขที่ใบตรวจรับ
- วันที่รับ
- เลขที่ PO
- ผู้ขาย
- รายการยาที่รับ (พร้อม Lot, Exp)
- จำนวนสั่ง vs รับจริง
- ช่องลงนามกรรมการตรวจรับ (3 คน):
  ✅ ประธานกรรมการ
  ✅ กรรมการ
  ✅ กรรมการและเลขานุการ
```

**สิ่งที่ระบบเราต้องมี:**
```
❌ ต้องเพิ่ม: receipt_inspectors (กรรมการหลายคน)
   - inspector_name
   - inspector_position
   - inspector_role (ประธาน/กรรมการ/เลขา)
   - signed_date
   - signature_image
```

---

#### 4.3 กรรมการตรวจรับ

**ขั้นตอนตรวจรับ (จากคู่มือ):**

```
1. พิมพ์ใบตรวจรับ (จากระบบ)
   ↓
2. กรรมการตรวจสอบ:
   ✅ ตรวจนับจำนวน (ถูกต้องตาม PO หรือไม่)
   ✅ ตรวจคุณภาพ (ยาดี, ไม่เสีย)
   ✅ ตรวจ Lot Number (ตรงกับที่บันทึกหรือไม่)
   ✅ ตรวจวันหมดอายุ (ยังไม่หมดอายุ, เหลือนานพอ)
   ✅ ตรวจบรรจุภัณฑ์ (ไม่เสียหาย)
   ↓
3. กรรมการลงนามในใบตรวจรับ (3 คน)
   - ประธานกรรมการ
   - กรรมการ (คนที่ 1)
   - กรรมการและเลขานุการ
   ↓
4. ส่งใบตรวจรับกลับคลัง
```

**Timeline:**
```
⏰ ปกติ: 30-60 นาที
⏰ กรณีพิเศษ: 1-2 ชั่วโมง (ถ้ามีปัญหา)
```

**Status ที่ควรมี:**
```
❌ ระบบเราควรมี:
   - DRAFT (บันทึกรับแล้ว รอพิมพ์ใบตรวจรับ)
   - PENDING_VERIFICATION (ส่งให้กรรมการแล้ว รอตรวจรับ)
   - VERIFIED (กรรมการตรวจรับเรียบร้อย)
   - POSTED (ยืนยันในระบบแล้ว คงคลังเพิ่ม)
```

---

#### 4.4 ยืนยันในระบบ

**หลังกรรมการตรวจรับเรียบร้อย:**

```
เจ้าหน้าที่คลัง:
1. รับใบตรวจรับที่มีลายเซ็นกรรมการ
2. เข้าระบบ → หน้า "รอยืนยัน"
3. เลือกรายการที่กรรมการตรวจรับแล้ว
4. คลิก "ยืนยัน" (Confirm/Post)
   ↓
ระบบทำงานอัตโนมัติ:
   ✅ เปลี่ยนสถานะ Receipt → POSTED
   ✅ เพิ่มคงคลัง (Inventory +)
   ✅ เพิ่มข้อมูล Lot (Drug Lots)
   ✅ อัพเดทสถานะ PO → RECEIVED
   ✅ ปิด Budget Reservation
   ✅ บันทึก Transaction Log
```

**สิ่งที่ระบบเราต้องมี:**
```
✅ มีแล้ว: status ใน receipts
🟡 ต้องแก้: เพิ่ม status PENDING_VERIFICATION
✅ มีแล้ว: DrugLot เชื่อมกับ receipt
✅ มีแล้ว: Inventory
```

---

#### 4.5 ส่งเอกสารการเงิน

**เอกสารที่ต้องส่ง (6 ฉบับ):**

```
1. ✅ ใบขออนุมัติ (มีลายเซ็นผู้อนุมัติ)
2. ✅ ใบสั่งซื้อ (PO)
3. ✅ ใบตรวจรับ (มีลายเซ็นกรรมการ 3 คน)
4. ✅ ใบนำส่งเวชภัณฑ์เข้าคลัง
5. ✅ Invoice / ใบกำกับภาษี (จากผู้ขาย)
6. ✅ Delivery Note (จากผู้ขาย)
```

**Flow การส่งเอกสาร:**
```
1. คลังรวบรวมเอกสารครบ 6 ฉบับ
   ↓
2. ส่งเอกสารให้การเงิน
   ↓
3. การเงินตรวจสอบ:
   - เอกสารครบหรือไม่
   - ลายเซ็นครบหรือไม่
   - ตัวเลขตรงกันหรือไม่
   ↓
4. การเงินอนุมัติจ่ายเงิน
   ↓
5. การเงินจ่ายเงินให้ผู้ขาย
   ↓
6. การเงินส่งข้อมูลกลับคลัง (ว่าจ่ายเงินแล้ว)
```

**สิ่งที่ระบบเราต้องมี:**
```
❌ ต้องเพิ่ม: payment_documents
   - payment_doc_number
   - receipt_id
   - po_id
   - vendor_id
   - total_amount
   - submitted_to_finance_date ⭐
   - approved_date
   - paid_date ⭐
   - payment_status (PENDING, APPROVED, PAID)
   - payment_method
   - payment_reference

❌ ต้องเพิ่ม: payment_attachments
   - payment_doc_id
   - attachment_type (PO, RECEIPT, INVOICE, etc.)
   - file_path
```

---

## 📊 สรุปการวิเคราะห์จากคู่มือ

### ✅ สิ่งที่ระบบเรามีแล้ว (70%)

```
✅ Master Data ครบ
✅ purchase_orders (ใบสั่งซื้อ)
✅ receipts (ใบรับเวชภัณฑ์)
✅ receipt_items (รายการรับพร้อม Lot, Exp)
✅ budget_allocations (งบประมาณ)
✅ budget_reservations (จองงบ)
✅ drug_lots (FEFO)
```

---

### ❌ สิ่งที่ยังขาด (30%)

#### 🔴 **Priority 1 - Critical (ไม่มีทำงานไม่ได้)**

**1. ระบบสัญญา** ⭐⭐⭐
```sql
❌ contracts
❌ contract_items
```
**Impact:** ไม่สามารถบันทึกสัญญา, ไม่มีราคาอ้างอิง, ไม่เช็คเกินสัญญา

**2. กรรมการตรวจรับหลายคน** ⭐⭐⭐
```sql
❌ receipt_inspectors (3 คน: ประธาน, กรรมการ, เลขา)
🟡 เพิ่มฟิลด์: invoice_number, invoice_date
```
**Impact:** ไม่สามารถลงลายเซ็นกรรมการครบ, พิมพ์ใบตรวจรับไม่ได้

**3. ใบขออนุมัติแยก** ⭐⭐
```sql
❌ approval_documents (เลขที่แยกจาก PO)
```
**Impact:** ไม่มีเอกสาร "ใบขออนุมัติ" แยกต่างหาก

---

#### 🟡 **Priority 2 - Important (มีจะดีมาก)**

**4. ระบบแนะนำ "ควรซื้ออะไร?"** ⭐⭐
```sql
❌ VIEW reorder_suggestions
❌ FUNCTION calculate_suggested_quantity()
❌ FUNCTION get_average_usage()
❌ FUNCTION get_last_purchase_info()
```

**5. ติดตามการจ่ายเงิน** ⭐⭐
```sql
❌ payment_documents
❌ payment_attachments
```

**6. Status ที่ละเอียดขึ้น** ⭐
```sql
🟡 แก้ไข ReceiptStatus:
   - เพิ่ม PENDING_VERIFICATION
   - แยก received_date, verified_date, posted_date
```

---

## 📋 ตารางที่ต้องเพิ่ม (สรุป)

### Phase 1: Critical (6 วัน)

```sql
1. contracts (3 วัน)
   ├─ id, contract_number, contract_type
   ├─ vendor_id, start_date, end_date
   ├─ total_value, payment_terms
   └─ status, created_at, updated_at

2. contract_items (รวมกับ contracts)
   ├─ id, contract_id, drug_id
   ├─ unit_price, min_quantity, max_quantity
   └─ discount_rate, notes

3. receipt_inspectors (2 วัน)
   ├─ id, receipt_id
   ├─ inspector_name, inspector_position
   ├─ inspector_role (CHAIRMAN, MEMBER, SECRETARY)
   ├─ signed_date, signature_path
   └─ remarks

4. approval_documents (1 วัน)
   ├─ id, approval_doc_number
   ├─ po_id, approval_type
   ├─ requested_by, requested_date
   ├─ approved_by, approval_date
   └─ status, document_path

+ เพิ่มฟิลด์ใน receipts:
   ├─ invoice_number ⭐
   ├─ invoice_date ⭐
   ├─ received_date
   ├─ verified_date
   └─ posted_date
```

---

### Phase 2: Important (4.5 วัน)

```sql
5. payment_documents (2 วัน)
6. reorder_suggestions VIEW (2 วัน)
7. แก้ไข enum ReceiptStatus (0.5 วัน)
```

---

## 🎯 คำแนะนำ

### จากการวิเคราะห์คู่มือ:

**ระบบเดิมมีความสมบูรณ์มาก** โดยเฉพาะ:
1. ✅ ระบบสัญญา - มีครบทุกอย่าง
2. ✅ กรรมการตรวจรับ 3 คน - ตามระเบียบราชการ
3. ✅ ใบขออนุมัติแยก - มีเลขที่แยกจาก PO
4. ✅ ติดตามการจ่ายเงิน - รู้ว่าจ่ายแล้วหรือยัง

**ระบบเราต้องเพิ่ม:**
- 🔴 สัญญา (สำคัญที่สุด)
- 🔴 กรรมการหลายคน
- 🟡 ใบขออนุมัติแยก
- 🟡 ระบบแนะนำ "ควรซื้ออะไร?"

---

## 📞 ขั้นตอนถัดไป

### รอข้อมูล MySQL Import เสร็จ:
- [ ] ดูโครงสร้างตารางจริงจาก MySQL
- [ ] ดูความสัมพันธ์ระหว่างตาราง
- [ ] ดูตัวอย่างข้อมูล
- [ ] อัพเดต Gap Analysis ให้แม่นยำ

### หลัง MySQL Import:
- [ ] สร้าง Migration สำหรับเพิ่มตาราง
- [ ] อัพเดต Prisma Schema
- [ ] สร้าง Seed Data
- [ ] เขียน Business Logic Functions

---

**สถานะ:** 🔄 กำลังรอข้อมูล MySQL Import เสร็จ...

**อัพเดทล่าสุด:** 20 ตุลาคม 2568 07:15 น.

---

*เอกสารนี้จะอัพเดทอีกครั้งหลัง MySQL import เสร็จ*
